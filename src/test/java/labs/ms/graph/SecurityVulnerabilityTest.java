/**
 * Lab MS Graph
 *
 *  @author antonio.caccamo
 *  @date 26 apr 2024
 */


package labs.ms.graph;

import static org.junit.jupiter.api.Assertions.*;

import io.quarkus.test.junit.QuarkusTest;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import labs.ms.graph.clients.MsGraphClient;
import labs.ms.graph.resources.BooksResource;
import labs.ms.graph.resources.ReportResource;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

@QuarkusTest
public class SecurityVulnerabilityTest {

  @Test
  @DisplayName("Verify all endpoints require authentication")
  public void testAuthenticationRequired() {
    // Check BooksResource endpoint is protected
    assertTrue(
        BooksResource.class.isAnnotationPresent(io.quarkus.security.Authenticated.class),
        "BooksResource should require authentication");

    // Check ReportResource endpoint is protected
    assertTrue(
        ReportResource.class.isAnnotationPresent(io.quarkus.security.Authenticated.class),
        "ReportResource should require authentication");
  }

  @Test
  @DisplayName("Verify secure configuration properties")
  public void testSecureConfiguration() {
    // Check sensitive config properties are not hardcoded
    assertDoesNotContain(
        readFileContent("src/main/resources/application.properties"),
        "client-secret=",
        "Hardcoded client secrets found in application.properties");

    assertDoesNotContain(
        readFileContent("src/main/resources/application.properties"),
        "password=",
        "Hardcoded passwords found in application.properties");
  }

  @Test
  @DisplayName("Verify CORS configuration")
  public void testCorsConfiguration() {
    String props = readFileContent("src/main/resources/application.properties");

    // Verify CORS headers are properly restricted
    assertTrue(
        props.contains("quarkus.http.cors.origins="),
        "CORS origins should be explicitly configured");

    assertFalse(
        props.contains("quarkus.http.cors.origins=*"),
        "CORS origins should not allow all origins (*)");
  }

  @Test
  @DisplayName("Check Graph API client security")
  public void testGraphClientSecurity() {
    // Verify client uses secure token handling
    assertTrue(
        MsGraphClient.class.getDeclaredFields().length > 0,
        "Graph client should store credentials securely");

    // Check for proper exception handling
    assertDoesNotThrow(
        () -> {
          new MsGraphClient(null);
        },
        "Graph client should handle null config securely");
  }

  private String readFileContent(String filepath) {
    try {
      return Files.readString(Paths.get(filepath));
    } catch (IOException e) {
      fail("Could not read file: " + filepath);
      return "";
    }
  }

  private void assertDoesNotContain(String content, String searchString, String message) {
    assertFalse(content.contains(searchString), message);
  }
}
